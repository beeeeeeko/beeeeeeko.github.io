<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«</title>

<style>
body {
  margin: 0;
  font-family: sans-serif;
  background: black;
  color: white;
  text-align: center;
}

/* ===== ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ ===== */
#splashScreen {
  position: fixed;
  inset: 0;
  background: black;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  opacity: 0;
  transition: opacity 1s;
}

#splashScreen img {
  max-width: 60%;
}

#splashScreen.show { opacity: 1; }
#splashScreen.hide { opacity: 0; pointer-events: none; }

/* ===== ç”»é¢å…±é€š ===== */
#titleScreen, #game, #resultScreen {
  max-width: 600px;
  margin: auto;
  padding: 20px;
  display: none;
}

#titleScreen {
  padding-top: 80px;
}

#titleScreen button {
  margin-top: 30px;
}

#titleLogo {
  max-width: 80%;
  width: 450px;
  height: auto;
  margin: 40px auto 30px;
  display: block;
  animation: titleFloat 3s ease-in-out infinite;
}

@keyframes titleFloat {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

#monsterImg {
  max-width: 100%;
  height: 180px;
  object-fit: contain;
}

.bar {
  height: 20px;
  background: #555;
  margin-bottom: 10px;
  border-radius: 10px;
  overflow: hidden;
}
.bar-inner {
  height: 100%;
  transition: width 0.3s;
}
#playerBar { background: linear-gradient(90deg, #4caf50, #8bc34a); }
#enemyBar { background: linear-gradient(90deg, #f44336, #ff5722); }

#question, #explanation {
  white-space: pre-line;
  margin-top: 15px;
}

#choicesContainer {
  margin: 20px 0;
}

.choice-btn-full {
  width: 100%;
  background: rgba(100, 100, 100, 0.3);
  border: 2px solid #888;
  border-radius: 10px;
  padding: 15px 20px;
  margin: 10px 0;
  text-align: left;
  font-size: 18px;
  line-height: 1.6;
  color: white;
  cursor: pointer;
  transition: all 0.3s;
  font-family: sans-serif;
}

.choice-btn-full:hover:not(:disabled) {
  background: rgba(100, 100, 100, 0.5);
  border-color: #aaa;
  transform: translateX(5px);
}

.choice-btn-full:disabled {
  cursor: not-allowed;
}

.choice-btn-full.selected {
  background: rgba(33, 150, 243, 0.5);
  border-color: #2196F3;
  border-width: 3px;
  transform: translateX(5px);
}

.choice-number {
  display: inline-block;
  font-weight: bold;
  color: #FFD700;
  margin-right: 10px;
  font-size: 20px;
}

#nextBtn, #restartBtn {
  margin-top: 20px;
  padding: 15px 30px;
  font-size: 20px;
  cursor: pointer;
  background: #2196F3;
  color: white;
  border: none;
  border-radius: 5px;
  display: none;
}

#nextBtn:hover, #restartBtn:hover {
  background: #1976D2;
}

#answerBtn {
  padding: 15px 30px;
  font-size: 20px;
  cursor: pointer;
  background: #FF9800;
  color: white;
  border: none;
  border-radius: 5px;
  display: none;
}

#answerBtn:hover {
  background: #F57C00;
}

.start-btn {
  padding: 15px 30px;
  font-size: 20px;
  cursor: pointer;
  background: #4CAF50;
  color: white;
  border: none;
  border-radius: 5px;
  transition: all 0.3s;
}

.start-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.3);
}

.start-btn:active {
  transform: translateY(0);
}

.start-btn:disabled {
  background: #666;
  cursor: not-allowed;
  transform: none;
}

/* ===== æ¼”å‡º ===== */
#screenFlash {
  position: fixed;
  inset: 0;
  opacity: 0;
  pointer-events: none;
  z-index: 4000;
}

.flash-correct {
  background: rgba(255, 215, 0, 0.4);
  animation: flash 0.4s;
}
.flash-wrong {
  background: rgba(255, 0, 0, 0.4);
  animation: flash 0.4s;
}
.flash-heal {
  background: rgba(0, 255, 0, 0.5);
  animation: flash 0.6s;
}
.flash-levelup-intermediate {
  background: rgba(255, 193, 7, 0.6);
  animation: flash 0.6s;
}
.flash-levelup-advanced {
  background: rgba(255, 23, 68, 0.6);
  animation: flash 0.6s;
}

@keyframes flash {
  0% { opacity: 0; }
  50% { opacity: 1; }
  100% { opacity: 0; }
}

#popupText {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: bold;
  opacity: 0;
  pointer-events: none;
  z-index: 4500;
  text-shadow: 2px 2px 4px black;
}

.popup-show {
  animation: popup 1s forwards;
}

@keyframes popup {
  0% { transform: scale(0.5); opacity: 0; }
  30% { transform: scale(1.5); opacity: 1; }
  100% { transform: scale(2.5); opacity: 0; }
}

#defeatEffect, #gameoverEffect {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: bold;
  background: rgba(0,0,0,0.7);
  opacity: 0;
  pointer-events: none;
  z-index: 5000;
}

#defeatEffect.show {
  animation: explode 1s forwards;
}

#gameoverEffect.show {
  animation: gameoverAnim 1.5s forwards;
}

/* ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
#levelUpEffect {
  position: fixed;
  inset: 0;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  background: rgba(0,0,0,0.85);
  opacity: 0;
  pointer-events: none;
  z-index: 6000;
}

#levelUpEffect.show {
  animation: levelUpShow 2.5s forwards;
}

#levelUpText {
  font-size: 64px;
  font-weight: bold;
  color: #FFD700;
  text-shadow: 0 0 30px #FFD700, 0 0 60px #FFD700;
  margin-bottom: 30px;
}

#levelUpDifficulty {
  font-size: 80px;
  font-weight: bold;
  text-shadow: 0 0 40px currentColor;
}

#levelUpEffect.intermediate #levelUpDifficulty {
  color: #FFC107;
  animation: difficultyPulse 2.5s;
}

#levelUpEffect.advanced #levelUpDifficulty {
  color: #FF1744;
  animation: difficultyPulse 2.5s;
}

@keyframes levelUpShow {
  0% { opacity: 0; }
  10% { opacity: 1; }
  90% { opacity: 1; }
  100% { opacity: 0; }
}

@keyframes difficultyPulse {
  0%, 100% { transform: scale(1); }
  10%, 30%, 50% { transform: scale(1.3); }
  20%, 40%, 60% { transform: scale(1.1); }
}

@keyframes explode {
  from { transform: scale(1); opacity: 1; color: yellow; }
  to { transform: scale(3) rotate(360deg); opacity: 0; color: red; }
}

@keyframes gameoverAnim {
  0% { transform: scale(0.5); opacity: 0; color: red; }
  50% { transform: scale(1.2); opacity: 1; color: darkred; }
  100% { transform: scale(1); opacity: 1; color: darkred; }
}

#monsterImg.defeat {
  animation: monsterFly 1s forwards;
}

@keyframes monsterFly {
  to {
    transform: scale(0) rotate(360deg) translateY(-100px);
    opacity: 0;
  }
}

#score {
  font-size: 20px;
  margin: 10px 0;
  color: #FFD700;
}

#difficultyDisplay {
  font-weight: bold;
  text-shadow: 0 0 10px currentColor;
  transition: color 0.3s;
}

/* ãƒ©ãƒ³ã‚¯è¡¨ç¤ºã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes rankPop {
  0% { transform: scale(0) rotate(-180deg); opacity: 0; }
  50% { transform: scale(1.3) rotate(10deg); }
  100% { transform: scale(1) rotate(0deg); opacity: 1; }
}

.rank-S { color: #FFD700; text-shadow: 0 0 20px #FFD700; }
.rank-A { color: #00FF00; text-shadow: 0 0 20px #00FF00; }
.rank-B { color: #00BFFF; text-shadow: 0 0 20px #00BFFF; }
.rank-C { color: #FFA500; text-shadow: 0 0 20px #FFA500; }
.rank-D { color: #FF6347; text-shadow: 0 0 20px #FF6347; }
</style>
</head>

<body>

<!-- ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥ -->
<div id="splashScreen">
  <img src="LOGO/logo.png" alt="Company Logo">
</div>

<div id="screenFlash"></div>
<div id="popupText"></div>
<div id="levelUpEffect">
  <div id="levelUpText"></div>
  <div id="levelUpDifficulty"></div>
</div>
<div id="defeatEffect">MONSTER DEFEATED!</div>
<div id="gameoverEffect">GAME OVER</div>

<!-- ã‚¿ã‚¤ãƒˆãƒ« -->
<div id="titleScreen">
  <img id="titleLogo" src="LOGO/title.png" alt="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ã‚¯ã‚¤ã‚ºãƒãƒˆãƒ«">
  <p id="loadingText" style="min-height: 24px;">ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ä¸­...</p>
  <button id="startBtn" class="start-btn" onclick="startGame()" disabled>ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
</div>

<!-- ã‚²ãƒ¼ãƒ  -->
<div id="game">
  <div id="score">è¨ä¼æ•°: <span id="defeatedCount">0</span> | é€£ç¶šæ­£è§£: <span id="comboCount">0</span> | é›£æ˜“åº¦: <span id="difficultyDisplay">åˆç´š</span></div>
  
  <img id="monsterImg" alt="ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼">

  <div>ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼HP <span id="enemyHPText">100/100</span></div>
  <div class="bar"><div id="enemyBar" class="bar-inner"></div></div>

  <div>ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼HP <span id="playerHPText">100/100</span></div>
  <div class="bar"><div id="playerBar" class="bar-inner"></div></div>

  <div id="question"></div>
  
  <div id="choicesContainer">
    <button class="choice-btn-full" data-index="0"></button>
    <button class="choice-btn-full" data-index="1"></button>
    <button class="choice-btn-full" data-index="2"></button>
    <button class="choice-btn-full" data-index="3"></button>
  </div>

  <div id="explanation"></div>
  <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
    <button id="answerBtn" onclick="submitAnswer()">è§£ç­”ã™ã‚‹</button>
    <button id="nextBtn" onclick="nextQuiz()">æ¬¡ã®å•é¡Œã¸</button>
  </div>
</div>

<!-- ãƒªã‚¶ãƒ«ãƒˆç”»é¢ -->
<div id="resultScreen">
  <h1 style="color: #ff4444; text-shadow: 2px 2px 4px rgba(0,0,0,0.5);">GAME OVER</h1>
  
  <div id="rankDisplay" style="font-size: 72px; margin: 20px 0; animation: rankPop 0.5s ease-out;"></div>
  
  <div style="background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; margin: 20px 0;">
    <h2 style="color: #FFD700; margin-top: 0;">ğŸ“Š ãƒ—ãƒ¬ã‚¤çµæœ</h2>
    
    <div style="text-align: left; max-width: 400px; margin: auto;">
      <p style="margin: 10px 0; font-size: 18px;">
        ğŸ—“ï¸ <strong>æ—¥æ™‚:</strong> <span id="gameoverDateTime"></span>
      </p>
      <p style="margin: 10px 0; font-size: 18px;">
        â±ï¸ <strong>ãƒ—ãƒ¬ã‚¤æ™‚é–“:</strong> <span id="playTime"></span>
      </p>
      <p style="margin: 10px 0; font-size: 18px;">
        ğŸ‘¹ <strong>è¨ä¼æ•°:</strong> <span id="finalDefeated"></span>ä½“
      </p>
      <p style="margin: 10px 0; font-size: 18px;">
        âœ… <strong>æ­£è§£æ•°:</strong> <span id="correctCount"></span>å•
      </p>
      <p style="margin: 10px 0; font-size: 18px;">
        âŒ <strong>ä¸æ­£è§£æ•°:</strong> <span id="wrongCount"></span>å•
      </p>
      <p style="margin: 10px 0; font-size: 18px;">
        ğŸ“ˆ <strong>æ­£è§£ç‡:</strong> <span id="accuracy"></span>
      </p>
      <p style="margin: 10px 0; font-size: 18px;">
        ğŸ”¥ <strong>æœ€å¤§ã‚³ãƒ³ãƒœ:</strong> <span id="maxCombo"></span>é€£ç¶š
      </p>
      <p style="margin: 10px 0; font-size: 18px;">
        â­ <strong>åˆ°é”é›£æ˜“åº¦:</strong> <span id="maxDifficultyDisplay"></span>
      </p>
    </div>
  </div>
  
  <div id="rankComment" style="margin: 20px 0; font-size: 18px; color: #FFD700;"></div>
  
  <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
    <button class="start-btn" onclick="restartGame()" style="background: #4CAF50;">
      ğŸ”„ ãƒªãƒˆãƒ©ã‚¤
    </button>
    <button class="start-btn" onclick="goToTitle()" style="background: #2196F3;">
      ğŸ  ã‚¿ã‚¤ãƒˆãƒ«ã¸
    </button>
  </div>
</div>

<script>
// ========================================
// ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç”»åƒã®è¨­å®š
// monsterãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã«ç”»åƒã‚’è¿½åŠ ã—ãŸã‚‰ã€ã“ã®æ•°å€¤ã‚’å¤‰æ›´ã—ã¦ãã ã•ã„
// ä¾‹ï¼šmonster1.png ~ monster20.png ãŒã‚ã‚‹å ´åˆã¯ 20 ã«è¨­å®š
// ========================================
const MONSTER_COUNT = 15;

// ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼ç”»åƒã®é…åˆ—ã‚’è‡ªå‹•ç”Ÿæˆ
const monsterImages = Array.from({length: MONSTER_COUNT}, (_, i) => `monster/monster${i + 1}.png`);

let quizzes = [];
let quizzesBeginner = []; // åˆç´šå•é¡Œ
let quizzesIntermediate = []; // ä¸­ç´šå•é¡Œ
let quizzesAdvanced = []; // ä¸Šç´šå•é¡Œ
let comments = [];
let playerHP, enemyHP, defeatedCount;
let currentQuiz, shuffledChoices, isAnswering = true;
let isGameOver = false;
let lastQuizId = null;
let selectedIndex = null;
let currentDifficulty = "beginner"; // ç¾åœ¨ã®é›£æ˜“åº¦

// çµ±è¨ˆæƒ…å ±
let correctAnswers = 0;
let wrongAnswers = 0;
let currentCombo = 0;
let maxCombo = 0;
let maxDifficulty = "beginner"; // åˆ°é”ã—ãŸæœ€é«˜é›£æ˜“åº¦
let gameStartTime = 0;
let gameOverDateTime = "";

// ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆåˆç´šï¼‰
fetch("quizzes_beginner.json")
  .then(r => r.json())
  .then(d => {
    quizzesBeginner = d;
    quizzes = quizzesBeginner; // æœ€åˆã¯åˆç´š
    checkAllDataLoaded();
  })
  .catch(err => {
    console.error("åˆç´šã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
  });

// ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆä¸­ç´šï¼‰
fetch("quizzes_intermediate.json")
  .then(r => r.json())
  .then(d => {
    quizzesIntermediate = d;
    checkAllDataLoaded();
  })
  .catch(err => {
    console.error("ä¸­ç´šã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
  });

// ã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ï¼ˆä¸Šç´šï¼‰
fetch("quizzes_advanced.json")
  .then(r => r.json())
  .then(d => {
    quizzesAdvanced = d;
    checkAllDataLoaded();
  })
  .catch(err => {
    console.error("ä¸Šç´šã‚¯ã‚¤ã‚ºãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
  });

// ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
fetch("comments.json")
  .then(r => r.json())
  .then(d => {
    comments = d;
  })
  .catch(err => {
    console.error("ã‚³ãƒ¡ãƒ³ãƒˆãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ:", err);
    comments = [
      "ğŸ‰ ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼",
      "âœ¨ é ‘å¼µã‚Šã¾ã—ãŸã­ï¼",
      "ğŸ‘ ãƒŠã‚¤ã‚¹ãƒ•ã‚¡ã‚¤ãƒˆï¼"
    ];
  });

// ã™ã¹ã¦ã®ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
function checkAllDataLoaded() {
  if (quizzesBeginner.length > 0 && quizzesIntermediate.length > 0 && quizzesAdvanced.length > 0) {
    document.getElementById("loadingText").textContent = "â†“ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆâ†“";
    document.getElementById("startBtn").disabled = false;
  }
}

/* ===== ã‚¹ãƒ—ãƒ©ãƒƒã‚·ãƒ¥åˆ¶å¾¡ ===== */
window.onload = () => {
  const splash = document.getElementById("splashScreen");
  const title = document.getElementById("titleScreen");

  splash.classList.add("show");

  setTimeout(() => {
    splash.classList.remove("show");
    splash.classList.add("hide");
    setTimeout(() => {
      splash.style.display = "none";
      title.style.display = "block";
    }, 1000);
  }, 2000);
};

function startGame() {
  document.getElementById("titleScreen").style.display = "none";
  document.getElementById("game").style.display = "block";
  playerHP = 100;
  enemyHP = 100;
  defeatedCount = 0;
  isGameOver = false;
  
  correctAnswers = 0;
  wrongAnswers = 0;
  currentCombo = 0;
  maxCombo = 0;
  maxDifficulty = "beginner"; // æœ€é«˜é›£æ˜“åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
  gameStartTime = Date.now();
  lastQuizId = null;
  selectedIndex = null;
  currentDifficulty = "beginner"; // é›£æ˜“åº¦ã‚’åˆç´šã«
  quizzes = quizzesBeginner; // åˆç´šå•é¡Œã‚’ä½¿ç”¨
  
  updateScore();
  spawnEnemy();
  nextQuiz();
}

function restartGame() {
  document.getElementById("resultScreen").style.display = "none";
  document.getElementById("game").style.display = "block";
  playerHP = 100;
  enemyHP = 100;
  defeatedCount = 0;
  isGameOver = false;
  
  correctAnswers = 0;
  wrongAnswers = 0;
  currentCombo = 0;
  maxCombo = 0;
  maxDifficulty = "beginner"; // æœ€é«˜é›£æ˜“åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
  gameStartTime = Date.now();
  lastQuizId = null;
  selectedIndex = null;
  currentDifficulty = "beginner"; // é›£æ˜“åº¦ã‚’åˆç´šã«
  quizzes = quizzesBeginner; // åˆç´šå•é¡Œã‚’ä½¿ç”¨
  
  updateScore();
  spawnEnemy();
  nextQuiz();
}

function goToTitle() {
  document.getElementById("resultScreen").style.display = "none";
  document.getElementById("titleScreen").style.display = "block";
}

function spawnEnemy() {
  enemyHP = 100;
  const m = document.getElementById("monsterImg");
  m.src = monsterImages[Math.floor(Math.random() * monsterImages.length)];
  m.classList.remove("defeat");
  updateHP();
}

function nextQuiz() {
  if (isGameOver) return;
  
  if (enemyHP <= 0) {
    spawnEnemy();
  }
  
  isAnswering = true;
  selectedIndex = null; // é¸æŠã‚’ãƒªã‚»ãƒƒãƒˆ
  document.getElementById("explanation").textContent = "";
  document.getElementById("nextBtn").style.display = "none";
  document.getElementById("answerBtn").style.display = "none"; // è§£ç­”ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
  
  let availableQuizzes = quizzes;
  if (lastQuizId !== null && quizzes.length > 1) {
    availableQuizzes = quizzes.filter(q => q.id !== lastQuizId);
  }
  
  currentQuiz = availableQuizzes[Math.floor(Math.random() * availableQuizzes.length)];
  lastQuizId = currentQuiz.id;
  
  shuffledChoices = currentQuiz.choices
    .map((c, i) => ({c, ok: i === currentQuiz.answer}))
    .sort(() => Math.random() - 0.5);
  
  document.getElementById("question").textContent = `å•é¡Œï¼š${currentQuiz.question}`;
  
  const container = document.getElementById("choicesContainer");
  container.innerHTML = "";
  
  const choiceNumbers = ["â‘ ", "â‘¡", "â‘¢", "â‘£"];
  shuffledChoices.forEach((choice, index) => {
    const btn = document.createElement("button");
    btn.type = "button";
    btn.className = "choice-btn-full";
    btn.innerHTML = `<span class="choice-number">${choiceNumbers[index]}</span>${choice.c}`;
    btn.addEventListener('click', function() {
      selectChoice(index);
    });
    container.appendChild(btn);
  });
}

function flash(cls) {
  const f = document.getElementById("screenFlash");
  f.className = "";
  void f.offsetWidth;
  f.className = cls;
}

function popup(text, color) {
  const p = document.getElementById("popupText");
  p.textContent = text;
  p.style.color = color;
  p.className = "popup-show";
  setTimeout(() => p.className = "", 1000);
}

function selectChoice(index) {
  if (!isAnswering || isGameOver) return;
  
  // ã™ã¹ã¦ã®é¸æŠè‚¢ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’è§£é™¤
  const buttons = document.querySelectorAll(".choice-btn-full");
  buttons.forEach(btn => btn.classList.remove("selected"));
  
  // ã‚¯ãƒªãƒƒã‚¯ã—ãŸé¸æŠè‚¢ã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
  buttons[index].classList.add("selected");
  selectedIndex = index;
  
  // è§£ç­”ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
  document.getElementById("answerBtn").style.display = "inline-block";
}

function submitAnswer() {
  if (selectedIndex === null || !isAnswering || isGameOver) return;
  
  handleAnswer(selectedIndex);
  
  // è§£ç­”ãƒœã‚¿ãƒ³ã‚’éè¡¨ç¤º
  document.getElementById("answerBtn").style.display = "none";
}

function handleAnswer(i) {
  if (!isAnswering || isGameOver) return;
  isAnswering = false;
  
  const buttons = document.querySelectorAll(".choice-btn-full");
  buttons.forEach(btn => btn.disabled = true);

  if (shuffledChoices[i].ok) {
    correctAnswers++;
    currentCombo++;
    if (currentCombo > maxCombo) {
      maxCombo = currentCombo;
    }
    
    // HPå›å¾©ãƒã‚§ãƒƒã‚¯ï¼ˆ10ã®å€æ•°ï¼‰
    if (currentCombo > 0 && currentCombo % 10 === 0) {
      playerHP = Math.min(100, playerHP + 10);
      popup(`${currentCombo}é€£ç¶šæ­£è§£ï¼HPå›å¾©ï¼`, "#00FF00");
      flash("flash-heal");
      if (navigator.vibrate) {
        navigator.vibrate([50, 50, 50, 50, 50]);
      }
    }
    
    updateScore();
    changeDifficulty(); // é›£æ˜“åº¦å¤‰æ›´ãƒã‚§ãƒƒã‚¯
    
    const willDefeatMonster = (enemyHP - 25) <= 0;
    enemyHP = Math.max(0, enemyHP - 25);
    
    if (!willDefeatMonster) {
      flash("flash-correct");
      if (currentCombo % 10 !== 0) { // HPå›å¾©æ™‚ã¯PERFECTè¡¨ç¤ºã‚’ã‚¹ã‚­ãƒƒãƒ—
        popup("PERFECT!!", "gold");
      }
    }
    
    if (willDefeatMonster) {
      defeat();
    }
  } else {
    wrongAnswers++;
    currentCombo = 0;
    updateScore();
    
    const willGameOver = (playerHP - 25) <= 0;
    playerHP = Math.max(0, playerHP - 25);
    
    if (!willGameOver) {
      flash("flash-wrong");
      popup("MISS...", "red");
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }
    }
    
    if (willGameOver) {
      if (navigator.vibrate) {
        navigator.vibrate([100, 50, 100]);
      }
      gameOver();
      return;
    }
  }

  document.getElementById("explanation").textContent = currentQuiz.explanation;
  updateHP();
  
  if (!isGameOver) {
    document.getElementById("nextBtn").style.display = "inline-block";
  }
}

function defeat() {
  defeatedCount++;
  updateScore();
  
  const p = document.getElementById("popupText");
  p.className = "";
  p.textContent = "";
  
  const f = document.getElementById("screenFlash");
  f.className = "";
  
  const levelUp = document.getElementById("levelUpEffect");
  levelUp.className = "";
  
  document.getElementById("defeatEffect").classList.add("show");
  document.getElementById("monsterImg").classList.add("defeat");
  
  setTimeout(() => {
    document.getElementById("defeatEffect").classList.remove("show");
  }, 1000);
}

function gameOver() {
  isGameOver = true;
  
  const p = document.getElementById("popupText");
  p.className = "";
  p.textContent = "";
  
  const f = document.getElementById("screenFlash");
  f.className = "";
  
  const levelUp = document.getElementById("levelUpEffect");
  levelUp.className = "";
  
  const now = new Date();
  gameOverDateTime = `${now.getFullYear()}å¹´${now.getMonth() + 1}æœˆ${now.getDate()}æ—¥ ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
  
  const playTimeSeconds = Math.floor((Date.now() - gameStartTime) / 1000);
  const minutes = Math.floor(playTimeSeconds / 60);
  const seconds = playTimeSeconds % 60;
  const playTimeText = `${minutes}åˆ†${seconds}ç§’`;
  
  const totalQuestions = correctAnswers + wrongAnswers;
  const accuracyPercent = totalQuestions > 0 ? Math.round((correctAnswers / totalQuestions) * 100) : 0;
  
  let rank, rankClass;
  if (accuracyPercent >= 90) {
    rank = "S";
    rankClass = "rank-S";
  } else if (accuracyPercent >= 75) {
    rank = "A";
    rankClass = "rank-A";
  } else if (accuracyPercent >= 60) {
    rank = "B";
    rankClass = "rank-B";
  } else if (accuracyPercent >= 40) {
    rank = "C";
    rankClass = "rank-C";
  } else {
    rank = "D";
    rankClass = "rank-D";
  }
  
  const comment = comments.length > 0 
    ? comments[Math.floor(Math.random() * comments.length)]
    : "ãŠç–²ã‚Œæ§˜ã§ã—ãŸï¼";
  
  document.getElementById("gameoverEffect").classList.add("show");
  
  setTimeout(() => {
    document.getElementById("game").style.display = "none";
    document.getElementById("resultScreen").style.display = "block";
    
    document.getElementById("rankDisplay").textContent = rank;
    document.getElementById("rankDisplay").className = rankClass;
    document.getElementById("gameoverDateTime").textContent = gameOverDateTime;
    document.getElementById("playTime").textContent = playTimeText;
    document.getElementById("finalDefeated").textContent = defeatedCount;
    document.getElementById("correctCount").textContent = correctAnswers;
    document.getElementById("wrongCount").textContent = wrongAnswers;
    document.getElementById("accuracy").textContent = `${accuracyPercent}%`;
    document.getElementById("maxCombo").textContent = maxCombo;
    
    // æœ€é«˜é›£æ˜“åº¦ã‚’è¡¨ç¤º
    let maxDifficultyText = "";
    if (maxDifficulty === "beginner") {
      maxDifficultyText = "åˆç´š";
    } else if (maxDifficulty === "intermediate") {
      maxDifficultyText = "ä¸­ç´š";
    } else if (maxDifficulty === "advanced") {
      maxDifficultyText = "ä¸Šç´š";
    }
    document.getElementById("maxDifficultyDisplay").textContent = maxDifficultyText;
    
    document.getElementById("rankComment").textContent = comment;
    
    document.getElementById("gameoverEffect").classList.remove("show");
  }, 2000);
}

function updateHP() {
  document.getElementById("playerBar").style.width = playerHP + "%";
  document.getElementById("enemyBar").style.width = enemyHP + "%";
  document.getElementById("playerHPText").textContent = `${playerHP}/100`;
  document.getElementById("enemyHPText").textContent = `${enemyHP}/100`;
}

function updateScore() {
  document.getElementById("defeatedCount").textContent = defeatedCount;
  document.getElementById("comboCount").textContent = currentCombo;
  
  // é›£æ˜“åº¦è¡¨ç¤ºã‚’æ›´æ–°
  const difficultyDisplay = document.getElementById("difficultyDisplay");
  let difficultyText = "";
  let difficultyColor = "";
  
  if (currentDifficulty === "beginner") {
    difficultyText = "åˆç´š";
    difficultyColor = "#00FF00";
  } else if (currentDifficulty === "intermediate") {
    difficultyText = "ä¸­ç´š";
    difficultyColor = "#FFC107";
  } else if (currentDifficulty === "advanced") {
    difficultyText = "ä¸Šç´š";
    difficultyColor = "#FF1744";
  }
  
  difficultyDisplay.textContent = difficultyText;
  difficultyDisplay.style.color = difficultyColor;
}

function changeDifficulty() {
  if (currentCombo >= 5 && currentDifficulty !== "advanced") {
    currentDifficulty = "advanced";
    quizzes = quizzesAdvanced;
    maxDifficulty = "advanced";
    showLevelUpEffect("ä¸Šç´š", "advanced");
  } else if (currentCombo >= 3 && currentDifficulty === "beginner") {
    currentDifficulty = "intermediate";
    quizzes = quizzesIntermediate;
    if (maxDifficulty === "beginner") {
      maxDifficulty = "intermediate";
    }
    showLevelUpEffect("ä¸­ç´š", "intermediate");
  }
  updateScore();
}

function showLevelUpEffect(difficultyText, difficultyClass) {
  // ãƒã‚¤ãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³
  if (navigator.vibrate) {
    navigator.vibrate([200, 100, 200, 100, 200]);
  }
  
  // ç”»é¢ãƒ•ãƒ©ãƒƒã‚·ãƒ¥
  const f = document.getElementById("screenFlash");
  f.className = "";
  void f.offsetWidth;
  f.className = `flash-levelup-${difficultyClass}`;
  
  // ãƒ¬ãƒ™ãƒ«ã‚¢ãƒƒãƒ—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆè¡¨ç¤º
  const effect = document.getElementById("levelUpEffect");
  const text = document.getElementById("levelUpText");
  const difficulty = document.getElementById("levelUpDifficulty");
  
  text.textContent = "LEVEL UP!!";
  difficulty.textContent = difficultyText;
  
  effect.className = `show ${difficultyClass}`;
  
  setTimeout(() => {
    effect.className = "";
  }, 2500);
}
</script>

</body>
</html>
